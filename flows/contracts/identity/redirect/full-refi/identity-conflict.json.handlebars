{{#with (contract 'actions') as |actions|}}
  {{#if (or
    (eq actions.[1].statusCode 409)
    (boolean (hasActiveIncompleteApplication ../request.params.id ../applications))
    (boolean (hasActivePostSubmissionApplication ../request.params.id ../applications))
  )}}
    {
      "action": {
        "type": "modal",
        "properties": {
          "type": "flexible",
          "definition": {
            "content": [
              {
                "key": "header",
                "type": "header",
                "componentProps": {
                {{! Monolith / Cognito users and first time applying via Lending Platform (i.e. no in-flight incomplete or post-submission apps) }}
                {{#if (and
                  (eq actions.[1].statusCode 409)
                  (not (boolean (hasActiveIncompleteApplication ../request.params.id ../applications)))
                  (not (boolean (hasActivePostSubmissionApplication ../request.params.id ../applications)))
                )}}
                  "copy": "We found an account with this email.",
                  "subCopy": "Please log in to continue your application.",
                {{else}}
                  "copy": "Pick up where you left off?",
                  "subCopy": "You started an application with us on {{#if (boolean (hasActivePostSubmissionApplication ../request.params.id ../applications))}}{{ISODateToMMDDYYYY (lookup (lookup (hasActivePostSubmissionApplication ../request.params.id ../applications) "root") "createdAt")}} {{else}} {{ISODateToMMDDYYYY (lookup (lookup (hasActiveIncompleteApplication ../request.params.id ../applications) "root") "createdAt")}} {{/if}}. Would you like to continue from where you left off?",
                {{/if}}
                  "asset": {
                    "center": true,
                    "type": "LocalAsset",
                    "name": "illustrations.info"
                  }
                },
                "modalProps": {
                  "maxWidth": "400px",
                  "showCloseButton": false,
                  "outsideClickEnable": false
                }
              },
              {
                "key": "buttons",
                "type": "buttons",
                "componentProps": {
                  "stylePreset": "primaryTertiary",
                  "buttons": [
                  {{!Primary Button}}
                      {
                        {{! Monolith / Cognito users and first time applying via Lending Platform (i.e. no in-flight incomplete or post-submission apps) }}
                        {{#if (and
                          (eq actions.[1].statusCode 409)
                          (not (boolean (hasActiveIncompleteApplication ../request.params.id ../applications)))
                          (not (boolean (hasActivePostSubmissionApplication ../request.params.id ../applications)))
                        )}}
                          "copy": "Login",
                          "action": {
                              "type": "navigate",
                              "properties": {
                                "goTo": "{{../env.BASE_URL}}/_/auth/login?targetUrl=/_/apply/resume-with-legacy-account/{{../application.id}}",
                                "external": true
                              }
                          }
                        {{else}}
                          "copy": "Resume prior application",
                          "action": {
                              "type": "navigate",
                              "properties": {
                               {{! Monolith / Cognito users with and active post-submission application) }}
                               {{#if (and
                                  (eq actions.[1].statusCode 409)
                                  (boolean (hasActivePostSubmissionApplication ../request.params.id ../applications))
                                )}}
                                  "goTo": "{{env.BASE_URL}}/_/auth/login",
                               {{! Monolith / Cognito users with and active incomplete application) }}
                                {{else if (and
                                  (eq actions.[1].statusCode 409)
                                  (boolean (hasActiveIncompleteApplication ../request.params.id ../applications))
                                )}}
                                  "goTo": "{{env.BASE_URL}}/_/auth/login?targetUrl=/_/apply/resume/{{lookup (lookup ( hasActiveIncompleteApplication ../request.params.id ../applications) "root") "id"}}",
                                {{else}}
                               {{! Default redirect users to the verification page }}
                                  "goTo": "{{env.BASE_URL}}/_/auth/neasauth/verify?email={{escapeUrlParam ../request.body.values.email}}",
                                {{/if}}
                                "external": true
                              }
                          }
                        {{/if}}
                      }
                      {{!Secondary Button -- only shown when users have an incomplete application in-flight}}
                      {{#if (and
                        (boolean (hasActiveIncompleteApplication ../request.params.id ../applications))
                        (not (boolean (hasActivePostSubmissionApplication ../request.params.id ../applications)))
                      )}}
                        ,{
                          "copy": "Continue new application",
                          "action": {
                            {{!Users with a Monolith / Cognito account}}
                            {{#if (eq actions.[1].statusCode 409)}}
                              "type": "navigate",
                              "properties": {
                                "goTo": "{{../env.BASE_URL}}/_/auth/login?targetUrl=/_/apply/resume/{{../application.id}}",
                                "external": true
                              }
                            {{else}}
                              {{!Send verification code + redirect to Verification screen}}
                              "type": "request",
                              "properties": {
                                "manifest": "send-verification-email/{{../request.params.id}}",
                                "method": "POST"
                              }
                            {{/if}}
                          }
                        }
                      {{/if}}
                  ],
                  "groupProps": {
                    "flexDirection": "column",
                    "alignItems": "center"
                  }
                }
              }
            ]
          }
        }
      }
    }
  {{else}}
    {{!Redirect user to education screen}}
    {{{json (contract 'redirect-education')}}}
  {{/if}}
{{else}} null {{/with}}
