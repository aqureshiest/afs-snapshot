{{! Auth strategy formatter for NEAS response to /auth/interservice/verify }}
{
  "strategy": "neas",
  {{! This auth strategy is never internal }}
  "isInternal": false,
  {{!
    'authorization' is an array of contracts or manifests that evaluate to
    either true or false to indicate that some combination of authentication
    artifacts and input resources permits the requested operation
  }}
  "isAuthorized": {{{ json (coalesce (contract 'authorization')) }}},
  {{! Mark this strategy as successful if the response includes `isValid` }}
  {{#with (contract "response") as |response|}}
    {{#log}}
      {
        "message": "neas authorization",
        "isValid": {{{json response.results.isValid}}},
        "userId": {{{json response.results.userId}}},
        "applicationId": {{{json response.results.applicationId}}}
      }
    {{/log}}
    {{#if (and response.results.isValid (lt response.response.statusCode 400))}}
      "isValid": true,
      {{!  TODO: any claim obtained by the NEAS verify method should be mapped here }}
      "artifacts": {{#obj}}
          { "applicationId": {{{ json response.results.applicationId }}} }
          { "exp": {{{ json response.results.exp }}} }
          { "userId": {{{ json (coalesce response.results.userId response.results.candidateUserId) }}} }
          {{! A userId in the response indicates that a user has verified who they are either through PII-verification or signing in }}
          {{#if response.results.userId}}
            { "verified": true }
          {{else}}
            { "verified": false }
          {{/if}}
      {{/obj}}
    {{else}}
      "isValid": false
    {{/if}}
  {{else}}
    "isValid": null
  {{/with}}
}

